本说明从《算法说明-带加速度零点-带足底高度.md》更改而来，原文为四足版本，此处修改为双足版本。



## 双足模型

首先定义状态估计器的状态变量为：
$$
\pmb{x}:=(\pmb{p}\quad\dot{\pmb{p}}\quad\pmb{p}_\text{feW}^1\quad\pmb{p}_\text{feW}^2\quad\bar{\pmb{a}}) \in \mathbb{R}^{15\times1}
$$
其中$\pmb{p}$表示质心位置，$\pmb{p}_\text{feW}^i$表示世界坐标系下的右腿和左腿的足底位置。

​	定义观测变量为：
$$
\pmb{z}:=(\pmb{p}_\text{feL}^1\quad\pmb{p}_\text{feL}^2\quad\dot{\pmb{p}}_\text{feL}^1\quad\dot{\pmb{p}}_\text{feL}^2 \quad {p}_\text{feWz}^1\quad{p}_\text{feWz}^2) \in \mathbb{R}^{14\times1}
$$

其中$\pmb{p}_\text{feL}^i$表示机体坐标系下的右腿和左腿的足底位置

### **预测模型：**

IMU线性加速度如下计算：
$$
\mathbf{a}_\text{L}=\mathbf{R}_\mathrm{ZYX}\mathbf{a}-[0,0,9.81]^\text{T}
$$
​        显然，这种线性加速的计算方法是必然有零点偏差的。

​        卡尔曼滤波的基本模型即是单质点的加速度公式：
$$
\mathbf{p}^+=\mathbf{p}+\mathbf{v}\Delta t+0.5\mathbf{a}_\text{L} \Delta t^2 \\
\mathbf{v}^+=\mathbf{v}+\mathbf{a}_\text{L}\Delta t
$$
其中，$\mathbf{p}^+$和$\mathbf{v}^+$表示下个周期的质心位置和速度，$\Delta t$表示控制周期。

​      当然，考虑到$\mathbf{a}_\text{L}$必然会有零点误差，所以可以将上式修正为：
$$
\mathbf{p}^+=\mathbf{p}+\mathbf{v}\Delta t+0.5(\mathbf{a}_\text{L}+\bar{\mathbf{a}}) \Delta t^2 \\
\mathbf{v}^+=\mathbf{v}+(\mathbf{a}_\text{L}+\bar{\mathbf{a}})\Delta t
$$
  综上即可得到状态方程为：
$$
\begin{eqnarray*}
\pmb{x}^+ &=&
\begin{bmatrix}
\begin{matrix}
\mathrm{I}_3 &\Delta t \mathrm{I}_3 \\
0_3 & \mathrm{I}_3 
\end{matrix} & 0_{6\times6} & 
\begin{matrix} 0.5\mathrm{I}_3\Delta t^2 \\ \mathrm{I}_3\Delta t \end{matrix}\\
0_{6\times6} & \mathrm{I}_{6} & 0_{6\times3} \\
0_{3\times6} & 0_{3\times6} & \mathrm{I}_3
\end{bmatrix}
\pmb{x}+
\begin{bmatrix} 0.5 \cdot \mathbf{I}_{3} \Delta t^2 \\
\mathbf{I}_{3} \Delta t \\
\mathbf{0}_{6\times3} \\
0_{3\times3}
\end{bmatrix}\mathbf{a}_\text{L} \\

\pmb{z}&=&\begin{bmatrix}
\begin{matrix}
-\mathbf{I}_3 & \mathbf{0}_3 \\
-\mathbf{I}_3 & \mathbf{0}_3
\end{matrix} & \mathbf{I}_{6}  &
\begin{matrix}
-0.5 \cdot \mathbf{I}_{3} \Delta t^2 \\
-0.5 \cdot \mathbf{I}_{3} \Delta t^2
\end{matrix}    \\
\begin{matrix}
\mathbf{0}_3 & -\mathbf{I}_3 \\
\mathbf{0}_3 & -\mathbf{I}_3
\end{matrix} & \mathbf{0}_{6} &
\begin{matrix}
-\mathbf{I}_{3} \Delta t \\
-\mathbf{I}_{3} \Delta t
\end{matrix} \\
\begin{matrix}
\mathbf{0}_{2\times3} & \mathbf{0}_{2\times3} 
\end{matrix}
& [\pmb{e}_3;\pmb{e}_6;] 
& \mathbf{0}_{2\times3}

\end{bmatrix}
\pmb{x}
\end{eqnarray*}
$$

其中$\pmb{e}_i\in \mathbb{R}^{6\times1}$表示第$i$个元素为1的标准基向量，即第$i$个元素为1，其他位置均为0。

过程噪声矩阵定义如下：
$$
\mathbf{Q}=
\begin{bmatrix}
\begin{matrix}
\omega_{\pmb{p}} \mathbf{I}_3 &\mathbf{0}_3 \\
\mathbf{0}_3 & \omega_{\dot{\pmb{p}}}\mathbf{I}_3 
\end{matrix} & \mathbf{0}_{6\times6} & 0_{6\times3}\\
\mathbf{0}_{6\times6} & \omega_\mathrm{fe}\pmb{\xi}\mathbf{I}_{6} & 0_{6\times3} \\
0_{3\times6} & 0_{3\times6} & \omega_{a}\mathbf{I}_3
\end{bmatrix}
$$

其中$\pmb{\xi}$表示噪声更新函数，根据各腿的相位和高度对其方差进行更新，当某只脚处于腾空状态时改函数会输出较大的值，处于触底状态时会输出较小的值。具体定义如下：
$$
\pmb{\xi}=\mathbf{I}_{6}+k(\mathbf{I}_{6}-\text{diag}(
\begin{matrix}
\mathbb{C}^1 & \mathbb{C}^2
\end{matrix}) )
$$
其中$k$是一个非负可调参数。如上所示，最大的输出值为$(1+k)\mathbf{I}_{6}$，最小的输出值为$\mathbf{I}_{6}$。

​		其中$\mathbb{C}$定义为：
$$
\mathbb{C}=C_\phi\begin{bmatrix}
1 & 0 & 0 \\
0 & 1 & 0 \\
0 & 0 & C_z
\end{bmatrix}
$$
而$C_\phi$定义为：
$$
C_\phi=s\left[\text{erf}\left(12\frac{\phi}{W}-6\right)+\text{erf}\left(12\frac{1-\phi}{W}-6\right)-1\right]
$$

$$
\phi=\frac{t-t_c}{T_c}
$$

$$
\text{erf}(x)=\frac{1}{1+e^{-x}}
$$

其中，$s$按触地和腾空相不同分别取1或0。$W$决定了起始和相位结束时的上升及下降段大小，即所为mistrust phase window，取值范围在0-0.5。erf是sigmoid误差函数，$t_c$表示触地相开始时间，$T_c$表示触地相的总时长。注意此处$C_{\phi}$的表达与原文并不同，因为发现原文的式子与它的图中曲线并不对应，故做了相应修改。

​		$C_z$定义为：
$$
C_z=\left\{
\begin{array}{ll}
\exp(-k_+z_{fe}^2), & \text{for } z_{fe}\ge0 \\
\exp(-k_-z_{fe}^2), & \text{for } z_{fe}<0
\end{array}
\right.
$$

![置信函数](E:\CASIA_Research\Research_Projects\Bonnie双足机器人\状态估计\置信函数.png)

### **修正模型：**

反馈校正即根据状态空间模型中的输出方程进行计算：
$$
\pmb{z}&=&\begin{bmatrix}
\begin{matrix}
-\mathbf{I}_3 & \mathbf{0}_3 \\
-\mathbf{I}_3 & \mathbf{0}_3
\end{matrix} & \mathbf{I}_{6}  &
\begin{matrix}
-0.5 \cdot \mathbf{I}_{3} \Delta t^2 \\
-0.5 \cdot \mathbf{I}_{3} \Delta t^2
\end{matrix}    \\
\begin{matrix}
\mathbf{0}_3 & -\mathbf{I}_3 \\
\mathbf{0}_3 & -\mathbf{I}_3
\end{matrix} & \mathbf{0}_{6} &
\begin{matrix}
-\mathbf{I}_{3} \Delta t \\
-\mathbf{I}_{3} \Delta t
\end{matrix} \\
\begin{matrix}
\mathbf{0}_{2\times3} & \mathbf{0}_{2\times3} 
\end{matrix}
& [\pmb{e}_3;\pmb{e}_6;] 
& \mathbf{0}_{2\times3}

\end{bmatrix}
\pmb{x}
$$

$$
\pmb{z}:=(\pmb{p}_\text{feL}^1\quad\pmb{p}_\text{feL}^2\quad\dot{\pmb{p}}_\text{feL}^1\quad\dot{\pmb{p}}_\text{feL}^2 \quad {p}_\text{feWz}^1\quad{p}_\text{feWz}^2) \in \mathbb{R}^{14\times1}
$$



观测噪声定义为：
$$
\mathbf{R}&=&\begin{bmatrix}
 \nu_{feL}\pmb{\xi}\mathbf{I}_{6} & \mathbf{0}_{6}  & \mathbf{0}_2\\
 \mathbf{0}_{6} & \nu_{\dot{feL}}\pmb{\xi}\mathbf{I}_{6} & \mathbf{0}_2 \\
 \mathbf{0}_6 & \mathbf{0}_6 & \nu_h \pmb{\xi}_h \mathbf{I}_2 \end{bmatrix}
$$

其中$\pmb{\xi}_h$定义为：
$$
\pmb{\xi}_h=\mathbf{I}_{2}+k_h(\mathbf{I}_{2}-\text{diag}(
\begin{matrix}
\mathbb{C}_z^1\mathbb{C}_\phi^1 & \mathbb{C}_z^2\mathbb{C}_\phi^2
\end{matrix}) )
$$



​		附卡尔曼滤波器计算过程：

预测：
$$
\hat{\pmb{x}}_{k|k-1}=\mathbf{F}_k\hat{\pmb{x}}_{k-1}+\mathbf{B}_k\pmb{u}_k \\
\mathbf{P}_{k|k-1}=\mathbf{F}_k\mathbf{P}_{k-1}\mathbf{F}_k^\text{T}+\mathbf{Q}_k
$$
校正：
$$
\tilde{\pmb{y}}_k=\pmb{z}_k-\mathbf{H}_k\hat{\pmb{x}}_{k|k-1} \\
\mathbf{S}_k=\mathbf{H}_k\mathbf{P}_{k|k-1}\mathbf{H}_k^\text{T}+\mathbf{R}_k \\
\mathbf{K}_k=\mathbf{P}_{k|k-1}\mathbf{H}_k^\text{T}\mathbf{S}_k^{-1} \\
\hat{\pmb{x}}_{k|k}=\hat{\pmb{x}}_{k|k-1}+\mathbf{K}_k\tilde{\pmb{y}}_k \\
\mathbf{P}_{k|k}=(\mathbf{I}-\mathbf{K}_k\mathbf{H}_k)\mathbf{P}_{k|k-1}
$$



了
